$(function(){function e(){}function n(){P=I.CONTACTS,O.removeClass("active"),B.removeClass("active"),F.addClass("active"),a()}function t(){P=I.CHAT,O.removeClass("active"),B.addClass("active"),F.removeClass("active"),i()}function o(){P=I.SIGNUP,O.addClass("active"),B.removeClass("active"),F.removeClass("active"),s()}function a(){$("#conversation-list .greetings .name").text(E),console.log("Getting friendslist"),z.emit("get friendslist")}function i(){for(var e in localStorage.messages[H]);}function s(){}function r(){E=v(A.val().trim()),E&&(L=!0,z.emit("register",{username:E}))}function c(){var e=v($("#friendInput").val().trim());console.log("Adding Friend: "+e),e&&z.emit("add friend",{friend:e})}function l(){var e=y.val();e=v(e),e&&z.emit("send message",{message:e,targetUser:H})}function u(e){var n=$('<span class="username"/>').text(e.username),t=$('<span class="messageBody">').text(e.message),o=$('<li class="message"/>').data("username",e.username).addClass(typingClass).append(n,t);f(o)}function g(){L&&navigator.geolocation&&navigator.geolocation.getCurrentPosition(m,d,{}),setTimeout(g,5e3)}function m(e){var n=e.coords.latitude,t=e.coords.longitude;z.emit("update location",{lat:n,lng:t})}function d(e){alert(e)}function f(e){var n=$(e);b[0].scrollTop=b[0].scrollHeight}function v(e){return $("<div/>").text(e).text()}function p(e){console.log("Opening alert "+e.title),$("#genericAlert .title").html(e.title),$("#genericAlert .content").html(e.content),$("#genericAlert").foundation("open")}function C(e){console.log("Opening error "+e.title),$("#genericError .title").html(e.title),$("#genericError .content").html(e.content),$("#genericError").foundation("open")}var N=150,h="http://172.26.101.113:3000/",I={SIGNUP:0,CONTACTS:1,CHAT:2},S=$(window),A=$("#usernameInput"),T=$("#registerUsernameInput"),b=$(".messages"),y=$(".inputMessage"),x=$("#setNamesButton");newphotoDiv=document.getElementById("newPhoto");var B=$("#conversation"),k=$("#conversation.bottom-bar.sendMessageInterface"),w=$("#conversation.bottom-bar.unavaliableInterface"),U=$("#conversation.chatArea.your-name.username"),F=$("#conversation-list"),G=$("#friendInput"),M=$("#contacts-list"),O=$("#setup"),P=I.SIGNUP,E,H,L=!1,z=io.connect(h);z.on("connect",function(){void 0!=localStorage.username?(console.log("Trying to login with found username "+localStorage.username),z.emit("login",{username:localStorage.username})):(console.log("Not logged in."),o()),g()}),$("#sendMessageButton").click(function(){l()}),$("#changeNameButton").click(function(){r()}),$("#setNamesButton").click(function(){E=v($("#registerUsernameInput").val().trim()),E&&(L=!0,z.emit("register",{username:E}))}),$("#addFriendButton").click(function(){c()}),$("#refreshFriendsList").click(function(){i()}),z.on("login result",function(e){e.success?(L=!0,E=e.username,localStorage.username=E,console.log("Logged in as: "+e.username),n()):(C({title:"Login Failed",content:e.errorMessage}),o())}),z.on("available",function(e){}),z.on("friendslist",function(e){if(M.empty(),console.log(e),0==e.size())console.log("You have no friends.");else for(var n in e){console.log("Got friend "+n.friendName);var o=$('<span class="name"/>').text(n.friendName),a=$('<span class="status">').text(n.friendAvaliability),i=$('<li class="contact"/>').data("friendName",n.friendName).append(o,a).click(function(){console.log("Opening conversation between"+n.friendName),H=n.friendName,t()});M.append(i)}}),z.on("incoming message",function(e){console.log("got message "+e),u(e)}),z.on("register result",function(e){console.log("register result"+e),e.success?(E=e.username,localStorage.username=E,L=!0,n()):(C({title:"Registration Failed",content:e.errorMessage}),o())}),$(document).ready(function(){e()})});